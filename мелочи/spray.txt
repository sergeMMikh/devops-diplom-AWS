sudo apt install -y git python3 python3-pip python3.10-venv
git clone https://github.com/kubernetes-sigs/kubespray.git
cd kubespray/

git checkout release-2.26

python3 -m venv .venv && source .venv/bin/activate
cp -rfp inventory/sample inventory/mycluster

# IP начиная с матер ноды
declare -a IPS=(10.10.10.100 10.10.11.101 10.10.10.102)
pip3 install ruamel.yaml

CONFIG_FILE=inventory/mycluster/hosts.yaml python3 contrib/inventory_builder/inventory.py ${IPS[@]}
nano inventory/mycluster/hosts.yaml

# разобраться с ключами
# nano ~/.ssh/1207_4_Crystall.pem
# sudo chmod 700 ~/.ssh/1207_4_Crystall.pem

git checkout master
python3 -m pip install -r requirements.txt
ansible all -m ping -i inventory/mycluster/hosts.yaml -u ubuntu --private-key ~/.ssh/1207_4_Crystall.pem

# nano inventory/mycluster/group_vars/k8s_cluster/k8s-cluster.yml
sed -i -e '/kubeadm_patches:/s/^/#/' \
       -e '/enabled: false/s/^/#/' \
       -e '/source_dir: "{{ inventory_dir }}\/patches"/s/^/#/' \
       -e '/dest_dir: "{{ kube_config_dir }}\/patches"/s/^/#/' \
       inventory/mycluster/group_vars/k8s_cluster/k8s-cluster.yml


ansible-playbook -i inventory/mycluster/hosts.yaml cluster.yml -u ubuntu --private-key ~/.ssh/1207_4_Crystall.pem -b -v &

mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config

